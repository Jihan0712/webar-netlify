<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>INRL AR — Admin Register</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  </head>
  <body class="min-h-screen bg-gray-100 flex items-center justify-center">
    <div id="container" class="w-full max-w-lg bg-white rounded shadow p-6">
      <h1 class="text-2xl font-bold mb-4">INRL AR — Admin Registration</h1>

      <div id="status" class="mb-4 text-sm"></div>

      <div id="forbidden" class="hidden text-red-600">Access denied. This page requires a valid access code.</div>

      <div id="form" class="hidden">
        <p class="text-sm text-gray-600 mb-3">This page is protected by a secret code. After signing in you may register yourself as an admin. Use responsibly.</p>

        <div id="userInfo" class="mb-3 text-sm text-gray-700"></div>

        <div id="authButtons" class="flex gap-2 mb-3">
          <button id="sendMagic" class="flex-1 bg-yellow-500 text-white rounded p-2">Send magic link</button>
          <button id="signOut" class="flex-1 bg-gray-200 rounded p-2 hidden">Sign out</button>
        </div>

        <button id="becomeAdmin" class="w-full bg-blue-600 text-white rounded p-2">Register me as admin</button>
      </div>
    </div>

    <script>
      // === CONFIGURE HERE ===
      // Replace this with a long secret string and keep it out of public commit history if possible.
      const ACCESS_CODE = 'REPLACE_WITH_A_LONG_SECRET';
      // ======================

      const SUPABASE_URL = "https://vleqrpqfjkcazeowczjy.supabase.co";
      const SUPABASE_ANON_KEY = "sb_publishable_yB6MBOTVLquZgR4X6yqhTQ_0wBFkhrZ";
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const params = new URLSearchParams(window.location.search);
  const code = params.get('code') || '';
  const token = params.get('token') || '';

      const forbiddenEl = document.getElementById('forbidden');
      const formEl = document.getElementById('form');
      const statusEl = document.getElementById('status');
      const userInfoEl = document.getElementById('userInfo');
      const sendMagicBtn = document.getElementById('sendMagic');
      const signOutBtn = document.getElementById('signOut');
      const becomeBtn = document.getElementById('becomeAdmin');

      function showStatus(txt, isError=false) {
        statusEl.textContent = txt;
        statusEl.style.color = isError ? 'crimson' : 'green';
      }

      // Gate access by either secret code OR a one-time token
      // If token is present, prefer token mode (one-time tokens are consumed server-side)
      const usingToken = !!token;
      if (usingToken) {
        forbiddenEl.classList.add('hidden');
        formEl.classList.remove('hidden');
        showStatus('Access allowed via one-time token. Sign in and click register to consume the token.');
      } else if (!code || code !== ACCESS_CODE) {
        forbiddenEl.classList.remove('hidden');
        formEl.classList.add('hidden');
        showStatus('Access blocked. Provide the correct code using ?code=YOUR_SECRET in the URL.', true);
      } else {
        forbiddenEl.classList.add('hidden');
        formEl.classList.remove('hidden');
        showStatus('Access allowed. Sign in with your email to continue.');
      }

      async function refreshUser() {
        const { data } = await supabase.auth.getUser();
        const user = data?.user || null;
        if (!user) {
          userInfoEl.textContent = 'Not signed in.';
          signOutBtn.classList.add('hidden');
          becomeBtn.disabled = true;
          return null;
        }
        userInfoEl.textContent = `Signed in as ${user.email} (id: ${user.id})`;
        signOutBtn.classList.remove('hidden');
        becomeBtn.disabled = false;
        return user;
      }

      // initialize
      (async () => {
        if (code === ACCESS_CODE) await refreshUser();
      })();

      sendMagicBtn.addEventListener('click', async () => {
        const email = prompt('Enter the email you want to sign in with:');
        if (!email) return;
        const redirect = window.location.origin + window.location.pathname + '?code=' + encodeURIComponent(ACCESS_CODE);
        const { error } = await supabase.auth.signInWithOtp({ email, options: { emailRedirectTo: redirect } });
        if (error) return showStatus('Error sending magic link: ' + (error.message || error), true);
        showStatus('Magic link sent — check your email and follow the link to return here.');
      });

      signOutBtn.addEventListener('click', async () => {
        await supabase.auth.signOut();
        await refreshUser();
        showStatus('Signed out.');
      });

      becomeBtn.addEventListener('click', async () => {
        const { data: userData, error: userErr } = await supabase.auth.getUser();
        const user = userData?.user;
        if (!user) return showStatus('You must be signed in to register as admin.', true);

        if (usingToken) {
          // Consume token via secure RPC
          try {
            const { data: rpcData, error: rpcErr } = await supabase.rpc('consume_admin_token', { p_token: token });
            if (rpcErr) {
              console.error('RPC error', rpcErr);
              return showStatus('Failed to consume token: ' + (rpcErr.message || JSON.stringify(rpcErr)), true);
            }
            if (!rpcData) {
              // Supabase may return null/empty for boolean; run a check
              // Try a simple query to see if you're now an admin
              const { data: admins, error: aerr } = await supabase.from('admins').select('*').eq('user_id', user.id);
              if (aerr) return showStatus('Consumed token but verification failed: ' + (aerr.message || aerr), true);
              if (!admins || admins.length === 0) return showStatus('Token consumption did not register you as admin.', true);
            }
            showStatus('Token consumed — you are now registered as an admin.');
          } catch (e) {
            console.error(e);
            return showStatus('Error consuming token: ' + (e?.message || String(e)), true);
          }
        } else {
          // legacy anon insert flow (works only if anon allowed to insert into admins)
          const { data, error } = await supabase
            .from('admins')
            .insert([{ user_id: user.id, email: user.email }])
            .select();

          if (error) {
            console.error('Insert admin error', error);
            return showStatus('Failed to register as admin: ' + (error.message || JSON.stringify(error)), true);
          }
          showStatus('Successfully registered as admin. You may now use admin features.');
        }
      });
    </script>
  </body>
</html>
