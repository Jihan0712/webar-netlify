<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>INRL AR Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  </head>
  <body class="bg-gray-100 text-gray-800 font-sans">
    <div class="flex min-h-screen">
      <!-- Sidebar -->
      <aside class="w-64 bg-gray-900 text-white flex flex-col p-6">
        <h1 class="text-2xl font-bold mb-8 text-center">INRL AR</h1>
        <nav class="flex flex-col space-y-3">
          <button id="uploadTab" class="py-2 px-3 rounded hover:bg-blue-700 text-left">Upload Target</button>
          <button id="listTab" class="py-2 px-3 rounded bg-blue-600 hover:bg-blue-700 text-left">Existing Targets</button>
        </nav>
        <footer class="mt-auto text-xs text-gray-400 pt-4 border-t border-gray-700">
          &copy; 2025 INRL
        </footer>
      </aside>

      <!-- Main content -->
      <main class="flex-1 p-8">
        <!-- Header with user info -->
        <div class="flex justify-between items-start mb-6">
          <p id="status" class="text-sm text-gray-600"></p>
          <div class="flex items-center gap-3">
            <select id="profileSelect" class="border rounded p-1 text-sm"></select>
            <button id="newProfile" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">New Profile</button>
            <div id="userMenu" class="text-sm text-gray-600"></div>
            <button id="signOut" class="bg-red-500 text-white px-2 py-1 rounded text-sm hover:bg-red-600">Sign out</button>
          </div>
        </div>

        <!-- Upload Section -->
        <section id="uploadSection" class="hidden">
          <h2 class="text-xl font-semibold mb-4">Upload a New AR Target</h2>
          <div class="bg-white shadow rounded-lg p-6 space-y-4">
            <div>
              <label class="block text-sm font-medium mb-1">Target Name</label>
              <input id="name" type="text" placeholder="Target name"
                class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-blue-500 outline-none" />
            </div>

            <div>
              <label class="block text-sm font-medium mb-1">Marker Image (.jpg/.png)</label>
              <div class="flex gap-2">
                <input id="markerFile" type="file" accept=".jpg,.jpeg,.png" class="flex-1 border p-2 rounded-md" />
                <button id="serverCompile" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition">
                  Compile on Server
                </button>
              </div>
              <p id="compileStatus" class="text-sm text-gray-500 mt-1"></p>
              <p class="text-xs text-gray-400">Tip: large images will be resized to 1024px max to speed up compilation.</p>
            </div>

            <div>
              <label class="block text-sm font-medium mb-1">.mp4 Video</label>
              <input id="videoFile" type="file" accept="video/mp4" class="w-full" />
            </div>

            <button id="upload" class="bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700">
              Upload
            </button>
          </div>
        </section>

        <!-- List Section -->
        <section id="listSection">
          <h2 class="text-xl font-semibold mb-4">Existing Targets</h2>
          <div id="targetsList" class="bg-white shadow rounded-lg overflow-hidden">
            <table class="w-full text-left border-collapse">
              <thead class="bg-gray-200">
                <tr>
                  <th class="p-3">Name</th>
                  <th class="p-3">Created</th>
                  <th class="p-3">Active</th>
                  <th class="p-3 text-center">Actions</th>
                </tr>
              </thead>
              <tbody id="targetsTable"></tbody>
            </table>
          </div>
        </section>
      </main>
    </div>

    <script type="module">
      // load TFJS (with fallbacks) and the Compiler (mind-ar)
      let Compiler = null;

      function loadScript(url) {
        return new Promise((resolve, reject) => {
          const s = document.createElement('script');
          s.src = url;
          s.onload = () => resolve();
          s.onerror = (e) => reject(new Error('Failed to load ' + url));
          document.head.appendChild(s);
        });
      }

      async function loadTfWithFallback() {
        const versions = ['4.16.0', '4.8.0', '4.20.0'];
        let lastErr = null;
        for (const v of versions) {
          try {
            await loadScript(`https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@${v}/dist/tf.min.js`);
            if (typeof tf !== 'undefined' && tf?.version?.tfjs) {
              console.log('Loaded tfjs', tf.version.tfjs);
              return;
            }
            throw new Error('tf not available after loading');
          } catch (err) {
            console.warn('Failed to load tfjs version', v, err.message);
            lastErr = err;
          }
        }
        throw lastErr || new Error('Failed to load any tfjs version');
      }

      // initialize TF and Compiler
      const readyPromise = (async () => {
        await loadTfWithFallback();
        try {
          const mod = await import('https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image.prod.js');
          Compiler = mod.Compiler;
          console.log('Loaded Compiler from mind-ar');
        } catch (err) {
          console.error('Failed to import mind-ar Compiler', err);
          throw err;
        }
      })();

      // Resize image helper
      async function resizeImage(file, maxDim = 1024) {
        const img = new Image();
        img.src = URL.createObjectURL(file);
        await img.decode();
        let { width, height } = img;
        if (width <= maxDim && height <= maxDim) return file;
        
        const aspect = width / height;
        if (width > height) {
          width = maxDim;
          height = Math.round(maxDim / aspect);
        } else {
          height = maxDim;
          width = Math.round(maxDim * aspect);
        }
        
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        
        return new Promise((resolve) => canvas.toBlob((blob) => {
          resolve(new File([blob], file.name, { type: 'image/jpeg' }));
        }, 'image/jpeg', 0.9));
      }

      // Supabase setup
      const SUPABASE_URL = "https://vleqrpqfjkcazeowczjy.supabase.co";
      const SUPABASE_ANON_KEY = "sb_publishable_yB6MBOTVLquZgR4X6yqhTQ_0wBFkhrZ";
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // App state
      let uploadedMindUrl = null;
      let currentUser = null;
      let profiles = [];
      let activeProfile = null;
      let isAdmin = false;
      let statusClearTimer = null;

      // DOM elements
      const elements = {
        status: document.getElementById("status"),
        uploadSection: document.getElementById("uploadSection"),
        listSection: document.getElementById("listSection"),
        uploadTab: document.getElementById("uploadTab"),
        listTab: document.getElementById("listTab"),
        targetsTable: document.getElementById("targetsTable"),
        compileStatus: document.getElementById("compileStatus"),
        profileSelect: document.getElementById("profileSelect"),
        userMenu: document.getElementById("userMenu")
      };

      function showStatus(message, isError = false, autoClear = true) {
        if (statusClearTimer) clearTimeout(statusClearTimer);
        elements.status.textContent = message;
        elements.status.style.color = isError ? 'crimson' : 'inherit';
        if (autoClear) {
          statusClearTimer = setTimeout(() => {
            elements.status.textContent = '';
            statusClearTimer = null;
          }, 5000);
        }
      }

      // Tab switching
      elements.uploadTab.addEventListener("click", () => {
        elements.uploadSection.classList.remove("hidden");
        elements.listSection.classList.add("hidden");
        elements.uploadTab.classList.add("bg-blue-600");
        elements.listTab.classList.remove("bg-blue-600");
      });

      elements.listTab.addEventListener("click", () => {
        elements.listSection.classList.remove("hidden");
        elements.uploadSection.classList.add("hidden");
        elements.listTab.classList.add("bg-blue-600");
        elements.uploadTab.classList.remove("bg-blue-600");
        loadTargets();
      });

      // Auth & profile management
      async function ensureAuth() {
        try {
          const { data } = await supabase.auth.getSession();
          const session = data?.session;
          if (!session) {
            window.location.href = '/login.html';
            return false;
          }
          
          currentUser = session.user;
          elements.userMenu.textContent = currentUser.email;
          
          // Check admin status
          console.log('Checking admin status for user:', currentUser.id);
          const { data: adminRows, error: adminErr } = await supabase
            .from('admins')
            .select('user_id')
            .eq('user_id', currentUser.id)
            .maybeSingle();
          
          console.log('Admin check result:', { adminRows, adminErr });
          isAdmin = !adminErr && adminRows;
          console.log(isAdmin ? '✅ User is admin' : '❌ User is not admin');

          // Load profiles and process any invitations
          await loadProfiles();
          
          // Handle profile selection from URL
          const params = new URLSearchParams(window.location.search);
          const pid = params.get('profileId');
          if (pid) {
            activeProfile = profiles.find(p => p.id === pid);
          } else if (!isAdmin && profiles.length === 1) {
            window.location.href = `/admin.html?profileId=${profiles[0].id}`;
            return true;
          }
          
          await loadTargets();
          return true;
        } catch (e) {
          console.error('Auth check failed:', e);
          window.location.href = '/login.html';
          return false;
        }
      }

      async function loadProfiles() {
        if (!currentUser) return;
        try {
          let query = supabase.from('profiles')
            .select('*')
            .order('created_at', { ascending: true });
          
          if (!isAdmin) query = query.eq('user_id', currentUser.id);
          
          const { data, error } = await query;
          if (error) throw error;
          profiles = data || [];
          
          renderProfileSelect();
        } catch (e) {
          console.warn('Could not load profiles:', e);
          showStatus('Failed to load profiles: ' + e.message, true);
          profiles = [];
        }
      }

      function renderProfileSelect() {
        const sel = elements.profileSelect;
        sel.innerHTML = '';
        
        const emptyOpt = document.createElement('option');
        emptyOpt.value = '';
        emptyOpt.textContent = profiles.length ? 'Select profile' : 'No profiles yet';
        sel.appendChild(emptyOpt);
        
        profiles.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.id;
          opt.textContent = isAdmin 
            ? `${p.name} ${p.brand ? '('+p.brand+')' : ''} — ${p.user_id}`
            : `${p.name} ${p.brand ? '('+p.brand+')' : ''}`;
          sel.appendChild(opt);
        });
        
        if (profiles.length === 1) {
          sel.value = profiles[0].id;
          activeProfile = profiles[0];
        } else if (activeProfile) {
          sel.value = activeProfile.id;
        }
        
        sel.onchange = () => {
          activeProfile = profiles.find(p => p.id === sel.value) || null;
          loadTargets();
        };
      }

      // Target management
      async function loadTargets() {
        console.log('Loading targets... (isAdmin:', isAdmin, ', activeProfile:', activeProfile, ')');
        
        if (!isAdmin && !activeProfile) {
          elements.targetsTable.innerHTML = '<tr><td colspan="4" class="p-3 text-center text-gray-500">Please select a profile to view targets</td></tr>';
          return;
        }

        try {
          let query = supabase.from("targets")
            .select("*")
            .order("created_at", { ascending: false });
          
          if (!isAdmin && activeProfile?.brand) {
            query = query.eq('brand', activeProfile.brand);
          }

          const { data, error } = await query;
          if (error) throw error;

          if (!data || data.length === 0) {
            elements.targetsTable.innerHTML = '<tr><td colspan="4" class="p-3 text-center text-gray-500">No targets found</td></tr>';
            return;
          }

          elements.targetsTable.innerHTML = data.map(t => {
            const isActive = t.is_active ? "✅" : "❌";
            const activeClass = t.is_active ? "bg-green-50 border-l-4 border-green-500" : "";
            const brandInfo = t.brand ? ` <span class="text-sm text-gray-500">(Brand: ${t.brand})</span>` : '';
            
            return `
              <tr class="${activeClass}">
                <td class="p-3">
                  <div class="font-medium">${t.name}</div>
                  ${brandInfo}
                </td>
                <td class="p-3 text-gray-500">${new Date(t.created_at).toLocaleString()}</td>
                <td class="p-3">${isActive}</td>
                <td class="p-3 text-center space-x-2">
                  <button onclick="setActive('${t.id}')" class="px-3 py-1 rounded bg-blue-500 text-white hover:bg-blue-600">Set Active</button>
                  <button onclick="editVideo('${t.id}', '${t.name}')" class="px-3 py-1 rounded bg-yellow-500 text-white hover:bg-yellow-600">Edit</button>
                  <button onclick="deleteTarget('${t.id}', '${t.name}', '${t.mindUrl}', '${t.videoUrl}')" class="px-3 py-1 rounded bg-red-500 text-white hover:bg-red-600">Delete</button>
                </td>
              </tr>`;
          }).join('');
        } catch (err) {
          console.error("Error in loadTargets:", err);
          showStatus("Error loading targets: " + (err.message || err), true);
        }
      }

      async function insertTarget(name, mindUrl, videoUrl) {
        const payload = {
          name,
          mindUrl,
          videoUrl,
          is_active: false,
          user_id: currentUser.id,
          brand: activeProfile?.brand
        };

        const { data, error } = await supabase.from('targets').insert([payload]);
        if (error) {
          // If brand column doesn't exist, retry without it
          if (error.message?.includes('column "brand" does not exist')) {
            delete payload.brand;
            return await supabase.from('targets').insert([payload]);
          }
          return { error };
        }
        return { data };
      }

      // Client-side marker compilation
      async function compileImageClient(markerFile, progressCallback) {
        await readyPromise;
        const fileToUse = await resizeImage(markerFile);
        const img = new Image();
        img.src = URL.createObjectURL(fileToUse);
        await img.decode();

        if (!Compiler) throw new Error('Compiler not loaded');

        const compiler = new Compiler();
        try {
          if (progressCallback) {
            await compiler.compileImageTargets([img], progressCallback);
          } else {
            await compiler.compileImageTargets([img]);
          }
        } catch (err) {
          console.error('Compilation failed:', err);
          throw err;
        }

        const buffer = compiler.exportData();
        if (!buffer) throw new Error('Failed to export compiled data');
        return buffer;
      }

      // Upload handlers
      document.getElementById('serverCompile').addEventListener('click', async () => {
        const markerFile = document.getElementById('markerFile').files[0];
        if (!markerFile) {
          showStatus('Please select an image file first.', true);
          return;
        }

        try {
          showStatus('Compiling marker image...', false, false);
          const buffer = await compileImageClient(markerFile, (p) => {
            elements.compileStatus.textContent = `Progress: ${p.toFixed(1)}%`;
          });

          elements.compileStatus.textContent = 'Uploading to storage...';
          const filename = markerFile.name.replace(/\.[^/.]+$/, '') + '.mind';
          const fileForUpload = new File([buffer], filename, { type: 'application/octet-stream' });
          const timestamp = Date.now();
          const mindPath = `minds/${timestamp}-${filename}`;
          
          const { error: mindErr } = await supabase.storage
            .from('assets')
            .upload(mindPath, fileForUpload);
          
          if (mindErr) throw mindErr;

          uploadedMindUrl = supabase.storage
            .from('assets')
            .getPublicUrl(mindPath)
            .data
            .publicUrl;
          
          elements.compileStatus.textContent = '✅ Ready to upload!';
          showStatus('Compilation complete!', false);
        } catch (err) {
          console.error('Compilation failed:', err);
          elements.compileStatus.textContent = `❌ Failed: ${err.message}`;
          showStatus('Compilation failed: ' + err.message, true);
        }
      });

      document.getElementById('upload').addEventListener('click', async () => {
        const name = document.getElementById('name').value.trim();
        const video = document.getElementById('videoFile').files[0];
        const markerFile = document.getElementById('markerFile').files[0];

        if (!name || (!uploadedMindUrl && !markerFile) || !video) {
          showStatus('Please fill all required fields', true);
          return;
        }

        try {
          showStatus('Uploading...', false, false);
          const timestamp = Date.now();
          const videoPath = `videos/${timestamp}-${video.name}`;

          // Handle new marker image if needed
          if (!uploadedMindUrl && markerFile) {
            showStatus('Compiling marker...', false, false);
            const buffer = await compileImageClient(markerFile, (p) => {
              elements.compileStatus.textContent = `Progress: ${p.toFixed(1)}%`;
            });

            const filename = markerFile.name.replace(/\.[^/.]+$/, '') + '.mind';
            const fileForUpload = new File([buffer], filename, { type: 'application/octet-stream' });
            const mindPath = `minds/${timestamp}-${filename}`;
            
            const { error: mindErr } = await supabase.storage
              .from('assets')
              .upload(mindPath, fileForUpload);
            
            if (mindErr) throw new Error('Mind file upload failed: ' + mindErr.message);

            uploadedMindUrl = supabase.storage
              .from('assets')
              .getPublicUrl(mindPath)
              .data
              .publicUrl;
          }

          // Upload video
          const { error: videoErr } = await supabase.storage
            .from('assets')
            .upload(videoPath, video);
          
          if (videoErr) throw new Error('Video upload failed: ' + videoErr.message);

          const videoUrl = supabase.storage
            .from('assets')
            .getPublicUrl(videoPath)
            .data
            .publicUrl;

          // Create database record
          const { error: dbErr } = await insertTarget(name, uploadedMindUrl, videoUrl);
          if (dbErr) throw new Error('Database insert failed: ' + dbErr.message);

          // Reset form
          document.getElementById('name').value = '';
          document.getElementById('videoFile').value = '';
          document.getElementById('markerFile').value = '';
          elements.compileStatus.textContent = '';
          uploadedMindUrl = null;

          showStatus('Upload complete!', false);
          loadTargets();
        } catch (err) {
          console.error('Upload failed:', err);
          showStatus('Upload failed: ' + err.message, true);
        }
      });

      // Target actions (exposed to global scope for onclick handlers)
      window.setActive = async (targetId) => {
        try {
          showStatus('Updating active target...', false, false);
          
          await supabase
            .from('targets')
            .update({ is_active: false })
            .neq('id', targetId);
          
          const { error } = await supabase
            .from('targets')
            .update({ is_active: true })
            .eq('id', targetId);
          
          if (error) throw error;
          
          showStatus('Target activated!');
          loadTargets();
        } catch (err) {
          console.error('Set active failed:', err);
          showStatus('Failed to set active: ' + err.message, true);
        }
      };

      window.editVideo = async (id, name) => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'video/mp4';
        input.click();

        input.onchange = async () => {
          const file = input.files[0];
          if (!file) return;

          try {
            showStatus('Uploading new video...', false, false);
            const timestamp = Date.now();
            const videoPath = `videos/${timestamp}-${file.name}`;

            const { error: uploadErr } = await supabase.storage
              .from('assets')
              .upload(videoPath, file);
            
            if (uploadErr) throw uploadErr;

            const videoUrl = supabase.storage
              .from('assets')
              .getPublicUrl(videoPath)
              .data
              .publicUrl;

            const { error: updateErr } = await supabase
              .from('targets')
              .update({ videoUrl })
              .eq('id', id);
            
            if (updateErr) throw updateErr;

            showStatus('Video updated!');
            loadTargets();
          } catch (err) {
            console.error('Video update failed:', err);
            showStatus('Failed to update video: ' + err.message, true);
          }
        };
      };

      window.deleteTarget = async (id, name, mindUrl, videoUrl) => {
        if (!confirm(`Are you sure you want to delete "${name}"?`)) return;
        const confirmText = prompt('Type "delete" to confirm:');
        if (confirmText?.toLowerCase() !== 'delete') {
          showStatus('Deletion cancelled', false);
          return;
        }

        try {
          showStatus('Deleting target...', false, false);

          // Delete database record first
          const { error: dbErr } = await supabase
            .from('targets')
            .delete()
            .eq('id', id);
          
          if (dbErr) throw dbErr;

          // Then clean up storage files
          const mindPath = mindUrl.split('/').slice(-2).join('/');
          const videoPath = videoUrl.split('/').slice(-2).join('/');
          await supabase.storage
            .from('assets')
            .remove([mindPath, videoPath]);

          showStatus('Target deleted!');
          loadTargets();
        } catch (err) {
          console.error('Delete failed:', err);
          showStatus('Failed to delete: ' + err.message, true);
        }
      };

      // Profile management
      document.getElementById('newProfile').addEventListener('click', async () => {
        if (!currentUser) {
          showStatus('Not signed in', true);
          return;
        }

        const name = prompt('Profile name (e.g., Marketing, Store A)');
        if (!name) return;
        
        const brand = prompt('Brand name (optional)');
        
        try {
          const { error } = await supabase
            .from('profiles')
            .insert([{
              name,
              brand: brand || null,
              user_id: currentUser.id
            }]);
          
          if (error) throw error;
          
          await loadProfiles();
          showStatus('Profile created!');
        } catch (e) {
          console.error('Create profile failed:', e);
          showStatus('Failed to create profile: ' + e.message, true);
        }
      });

      // Admin functions
      if (isAdmin) {
        // Add invite brand user button
        const inviteBtn = document.createElement('button');
        inviteBtn.textContent = 'Invite Brand User';
        inviteBtn.className = 'bg-yellow-500 text-white px-3 py-1 rounded text-sm hover:bg-yellow-600';
        inviteBtn.onclick = async () => {
          const email = prompt('Brand user email (required)');
          if (!email) return;
          
          const name = prompt('User display name (optional)');
          const brand = prompt('Assigned brand (required)');
          if (!brand) {
            showStatus('Brand is required', true);
            return;
          }

          try {
            const { error } = await supabase
              .from('invitations')
              .insert([{ email, name, brand }]);
            
            if (error) throw error;
            
            showStatus('Invitation created! Notify the user.');
            await loadProfiles();
          } catch (e) {
            console.error('Invite failed:', e);
            showStatus('Failed to create invitation: ' + e.message, true);
          }
        };
        document.getElementById('newProfile').insertAdjacentElement('afterend', inviteBtn);

        // Add generate admin invite button
        const genInviteBtn = document.createElement('button');
        genInviteBtn.textContent = 'Generate Admin Invite';
        genInviteBtn.className = 'bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600';
        genInviteBtn.onclick = async () => {
          const email = prompt('Email to associate (optional)');
          try {
            const { data, error } = await supabase.rpc(
              'create_admin_token',
              { p_email: email || null }
            );
            
            if (error) throw error;
            if (!data) throw new Error('No token returned');
            
            const link = window.location.origin + '/admin-register.html?token=' + encodeURIComponent(data);
            await navigator.clipboard.writeText(link);
            showStatus('Invite link copied to clipboard!');
          } catch (e) {
            console.error('Generate invite failed:', e);
            showStatus('Failed to generate invite: ' + e.message, true);
          }
        };
        inviteBtn.insertAdjacentElement('afterend', genInviteBtn);
      }

      // Sign out handler
      document.getElementById('signOut').addEventListener('click', async () => {
        await supabase.auth.signOut();
        window.location.href = '/login.html';
      });

      // Initialize
      await ensureAuth();
      // Start with list view
      elements.listTab.click();
    </script>
  </body>
</html>